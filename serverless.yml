service:
  name: serverless-testing-site

# Add the serverless-webpack plugin
plugins:
  - serverless-webpack
  - serverless-stack-output
custom:
  output:
    file: ./stack.yml
    handler: scripts/client.handler

provider:
  name: aws
  runtime: nodejs8.10

  stage: dev
  region: us-west-2

functions:
  resolvePageType:
    handler: functions/resolvePageType.resolvePageType
    role: readS3role
    environment:
      BUCKET: ${self:service}-public
  resolveAppSync:
    handler: functions/resolveAppSync.handler
    role: updateDbRole
    environment:
      FRAGMENTS_TABLE: ${self:service}-fragments

  update_data:
    handler: functions/update-data.updateData
    role: updateDbRole
    events:
      - http:
          method: put
          path: fragment
          authorizer: aws_iam
          cors: true
      - http:
          method: patch
          path: fragment/{id}
          authorizer: aws_iam
          cors: true
      - http:
          method: delete
          path: fragment/{id}
          authorizer: aws_iam
          cors: true

    environment:
      FRAGMENTS_TABLE: ${self:service}-fragments

  resize:
    handler: functions/resize-images.resizeImages
    role: resizeRole

    environment:
      BUCKET: ${self:service}
      IMG_TABLE: ${self:service}-images
      FRAGMENTS_TABLE: ${self:service}-fragments
      GRAPHQL:
        Fn::GetAtt: ["graphQLApi", "GraphQLUrl"]

  render:
    handler: functions/renderPages.handler
    role: resizeRole

    environment:
      BUCKET: ${self:service}-public
      FRAGMENTS_TABLE: ${self:service}-fragments
      GRAPHQL:
        Fn::GetAtt: ["graphQLApi", "GraphQLUrl"]


  createPage:
    handler: functions/create-page.createPage
    role: createPageRole
    environment:
      BUCKET: ${self:service}
      IMG_TABLE: ${self:service}-images
      PAGES_TABLE: ${self:service}-pages
      MENUS_TABLE: ${self:service}-menus


resources:
  Resources:
    S3BucketPublicsite: ${file(./settings/s3/s3bucket.yml)}
    S3BucketPolicy: ${file(./settings/s3/s3bucketPolicy.yml)}
    ResizeLambdaPermissionPhotosS3: ${file(./settings/s3/s3permission.yml)}
    resizeRole: ${file(./settings/roles/resizeRole.yml)}
    createPageRole: ${file(./settings/roles/createPageRole.yml)}
    updateDbRole: ${file(./settings/roles/updateDbRole.yml)}
    dataEditorRole: ${file(./settings/roles/dataEditorRole.yml)}
    sourceAppSyncRole: ${file(./settings/roles/sourceAppSyncRole.yml)}
    identityPoolRoleAttachment:  ${file(./settings/auth/identity-pool-role-attachment.yml)}
    fragmentsTable: ${file(./settings/tables.yml):fragmentsTable}
    readS3role:  ${file(./settings/roles/readS3role.yml)}

    userPool:  ${file(./settings/auth/user-pool.yml)}
    userPoolGroup: ${file(./settings/auth/user-pool-group.yml)}
    userPoolClient: ${file(./settings/auth/user-pool-client.yml)}

    identityPool:  ${file(./settings/auth/identity-pool.yml)}

    graphQLApi: ${file(./settings/graphql-api/graphql.yml)}
    graphQLSchema: ${file(./settings/graphql-api/graphql-schema.yml)}
    graphQLKey: ${file(./settings/graphql-api/graphql-key.yml)}
    graphQLData: ${file(./settings/graphql-api/graphql-datasource.yml)}
    graphQLLambda: ${file(./settings/graphql-api/graphql-datasource-lambda.yml)}
    graphQLPageTypesDataSource: ${file(./settings/graphql-api/graphql-datasource-page-types.yml)}

    # needs to be commented out on first deploy
    putMenu: ${file(./settings/graphql-api/resolvers/putMenu.yml)}
    putText: ${file(./settings/graphql-api/resolvers/putText.yml)}
    updateText: ${file(./settings/graphql-api/resolvers/updateText.yml)}
    removeText: ${file(./settings/graphql-api/resolvers/removeText.yml)}
    removePage: ${file(./settings/graphql-api/resolvers/removePage.yml)}
    putPage: ${file(./settings/graphql-api/resolvers/putPage.yml)}
    addImage: ${file(./settings/graphql-api/resolvers/addImage.yml)}
    addGallery: ${file(./settings/graphql-api/resolvers/addGallery.yml)}
    
    addImageToGallery: ${file(./settings/graphql-api/resolvers/addImageToGallery.yml)}
    addImagesToGallery: ${file(./settings/graphql-api/resolvers/addImagesToGallery.yml)}
    removeGallery: ${file(./settings/graphql-api/resolvers/removeGallery.yml)}
    removeImage: ${file(./settings/graphql-api/resolvers/removeImage.yml)}
    removeImageFromGallery: ${file(./settings/graphql-api/resolvers/removeImageFromGallery.yml)}
    reorderImagesInGallery:  ${file(./settings/graphql-api/resolvers/reorderImagesInGallery.yml)}
    getImageList: ${file(./settings/graphql-api/resolvers/getImageList.yml)}
    getGalleryList: ${file(./settings/graphql-api/resolvers/getGalleryList.yml)}
    getPageTypeList: ${file(./settings/graphql-api/resolvers/getPageTypeList.yml)}

    
    getText: ${file(./settings/graphql-api/resolvers/getText.yml)}
    getTextList: ${file(./settings/graphql-api/resolvers/getTextList.yml)}
    getPage: ${file(./settings/graphql-api/resolvers/getPage.yml)}
    getPageList: ${file(./settings/graphql-api/resolvers/getPageList.yml)}
    getMenu: ${file(./settings/graphql-api/resolvers/getMenu.yml)}
    getMenuList: ${file(./settings/graphql-api/resolvers/getMenuList.yml)}
    getImage: ${file(./settings/graphql-api/resolvers/getImage.yml)}
    getGallery: ${file(./settings/graphql-api/resolvers/getGallery.yml)}
    galleryImages: ${file(./settings/graphql-api/resolvers/gallery-images.yml)}



  Outputs:
    region:
      Value:
        Ref: "AWS::Region"
    CognitoARN:
      Value:
        Fn::GetAtt: ["userPool", "Arn"]
    userPoolId:
      Value:
        Ref: userPool
    userPoolWebClientId:
      Value:
        Ref: userPoolClient

    identityPoolId:
      Value:
        Ref: identityPool

    GraphQLUrl:
      Value:
        Fn::GetAtt: ["graphQLApi", "GraphQLUrl"]
    GraphQLARN:
      Value:
        Fn::GetAtt: ["graphQLApi", "Arn"]
    GraphQLApiId:
      Value:
        Fn::GetAtt: ["graphQLApi", "ApiId"]
    GraphQLApiKey:
      Value:
        Fn::GetAtt: ["graphQLKey", "ApiKey"]
    BucketName:
      Value: ${self:service}-public
